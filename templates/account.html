{% extends "base.html" %}

{% block title %}My Account - GoldenDoodleLM{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Profile Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <!-- Avatar with Initials -->
                            <div class="avatar-circle bg-primary text-white d-flex align-items-center justify-content-center">
                                {{ user.first_name[0].upper() }}{{ user.last_name[0].upper() }}
                            </div>
                        </div>
                        <div class="col">
                            <h2 class="mb-1">{{ user.first_name }} {{ user.last_name }}</h2>
                            <p class="text-muted mb-2">{{ user.email }}</p>
                            <div class="d-flex flex-wrap gap-2">
                                <span class="badge badge-primary ms-2">{{ user.subscription_level.value.title() }} Plan</span>
                                {% if user.is_admin %}
                                <span class="badge bg-success">Admin</span>
                                {% endif %}
                                {% if tenant.tenant_type.value == 'company' %}
                                <span class="badge bg-info">{{ tenant.name }} Member</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                                <i class="fas fa-edit me-1"></i>Edit Profile
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-calendar-alt text-primary mb-2" style="font-size: 2rem;"></i>
                    <h5>Member Since</h5>
                    <p class="text-muted">{{ user.created_at.strftime('%B %Y') if user.created_at else 'Recently' }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-microphone text-primary mb-2" style="font-size: 2rem;"></i>
                    <h5>Brand Voices</h5>
                    <p class="text-muted">{{ company_brand_voices|length }} Voices</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-building text-primary mb-2" style="font-size: 2rem;"></i>
                    <h5>Organization</h5>
                    <p class="text-muted">{{ tenant.name if tenant.tenant_type.value == 'company' else 'Personal Account' }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-check-circle text-primary mb-2" style="font-size: 2rem;"></i>
                    <h5>Account Status</h5>
                    <p class="text-muted">Active</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <a href="{{ url_for('brand_voice_wizard', type='company') }}" class="btn btn-outline-primary w-100">
                                <i class="fas fa-plus me-2"></i>Create Brand Voice
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('brand_voices') }}" class="btn btn-outline-success w-100">
                                <i class="fas fa-microphone me-2"></i>Manage Brand Voices
                            </a>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-warning w-100" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                <i class="fas fa-key me-2"></i>Change Password
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-purple w-100" data-bs-toggle="modal" data-bs-target="#inviteFriendsModal">
                                <i class="fas fa-user-friends me-2"></i>Invite Friends
                            </button>
                        </div>
                        {% if user.is_admin and tenant.tenant_type.value == 'company' %}
                        <div class="col-md-4">
                            <button class="btn btn-outline-info w-100" data-bs-toggle="modal" data-bs-target="#inviteTeamMemberModal">
                                <i class="fas fa-user-plus me-2"></i>Invite Team Member
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Settings Tabs -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="accountTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab">
                                <i class="fas fa-user me-1"></i>Profile
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="organization-tab" data-bs-toggle="tab" data-bs-target="#organization" type="button" role="tab">
                                <i class="fas fa-building me-1"></i>Organization
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="brand-voices-tab" data-bs-toggle="tab" data-bs-target="#brand-voices" type="button" role="tab">
                                <i class="fas fa-microphone me-1"></i>Brand Voices
                            </button>
                        </li>
                        {% if user.is_admin and tenant.tenant_type.value == 'company' %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="team-management-tab" data-bs-toggle="tab" data-bs-target="#team-management" type="button" role="tab">
                                <i class="fas fa-users me-1"></i>Team Management
                            </button>
                        </li>
                        {% endif %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="invitations-tab" data-bs-toggle="tab" data-bs-target="#invitations" type="button" role="tab">
                                <i class="fas fa-user-friends me-1"></i>My Invitations
                            </button>
                        </li>
                        {% if tenant.tenant_type.value == 'independent_user' %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="billing-tab" data-bs-toggle="tab" data-bs-target="#billing" type="button" role="tab">
                                <i class="fas fa-credit-card me-1"></i>Billing
                            </button>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="accountTabsContent">
                        <!-- Profile Tab -->
                        <div class="tab-pane fade show active" id="profile" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-3">Personal Information</h6>
                                    <div class="mb-3">
                                        <label class="form-label text-muted">First Name</label>
                                        <p class="fw-semibold">{{ user.first_name }}</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label text-muted">Last Name</label>
                                        <p class="fw-semibold">{{ user.last_name }}</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label text-muted">Email Address</label>
                                        <p class="fw-semibold">{{ user.email }}</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-3">Account Details</h6>
                                    <div class="mb-3">
                                        <label class="form-label text-muted">Subscription Level</label>
                                        <p class="fw-semibold">{{ user.subscription_level.value.title() }}</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label text-muted">Account Type</label>
                                        <p class="fw-semibold">{{ 'Admin' if user.is_admin else 'Member' }}</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label text-muted">User ID</label>
                                        <p class="fw-semibold font-monospace">{{ user.user_id }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Organization Tab -->
                        <div class="tab-pane fade" id="organization" role="tabpanel">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="text-primary mb-3">Organization Details</h6>
                                    <div class="mb-3">
                                        <label class="form-label text-muted">Organization Name</label>
                                        <p class="fw-semibold">{{ tenant.name }}</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label text-muted">Organization Type</label>
                                        <p class="fw-semibold">{{ 'Company' if tenant.tenant_type.value == 'company' else 'Individual Account' }}</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label text-muted">Your Role</label>
                                        <p class="fw-semibold">{{ 'Administrator' if user.is_admin else 'Member' }}</p>
                                    </div>
                                    {% if tenant.tenant_type.value == 'company' %}
                                    <div class="mb-3">
                                        <label class="form-label text-muted">Brand Voice Limit</label>
                                        <p class="fw-semibold">{{ company_brand_voices|length }} / {{ tenant.max_brand_voices }} Company Voices</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Brand Voices Tab -->
                        <div class="tab-pane fade" id="brand-voices" role="tabpanel">
                            <h6 class="text-primary mb-3">Organization Brand Voices</h6>
                            {% if company_brand_voices %}
                            <div class="row g-3">
                                {% for voice in company_brand_voices %}
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title">{{ voice.name }}</h6>
                                            <div class="mb-2">
                                                <small class="text-muted d-block">
                                                    <strong>Company:</strong> {{ voice.configuration.get('company_name', 'N/A') }}
                                                </small>
                                                <small class="text-muted d-block">
                                                    <strong>Website:</strong> {{ voice.configuration.get('company_url', 'N/A') }}
                                                </small>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <a href="{{ url_for('brand_voice_wizard', type='company', edit=voice.brand_voice_id) }}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-edit me-1"></i>Edit
                                                </a>
                                                <small class="text-muted align-self-center">Brand Voice</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-microphone text-muted mb-3" style="font-size: 60px; opacity: 0.5;"></i>
                                <h5>No Brand Voices Yet</h5>
                                <p class="text-muted">Create your first brand voice to get started.</p>
                                <a href="{{ url_for('brand_voice_wizard', type='company') }}" class="btn btn-primary">
                                    <i class="fas fa-plus me-1"></i>Create Brand Voice
                                </a>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Team Management Tab (for organization admins only) -->
                        {% if user.is_admin and tenant.tenant_type.value == 'company' %}
                        <div class="tab-pane fade" id="team-management" role="tabpanel">
                            <div class="row mb-4">
                                <div class="col-md-8">
                                    <h6 class="text-primary mb-3">Team Member Management</h6>
                                    <p class="text-muted">Invite new team members to join {{ tenant.name }} and manage pending invitations.</p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#inviteTeamMemberModal">
                                        <i class="fas fa-user-plus me-2"></i>Invite Team Member
                                    </button>
                                </div>
                            </div>

                            <!-- Pending Invitations -->
                            <div class="card mb-4">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">
                                        <i class="fas fa-envelope me-2"></i>Pending Invitations
                                    </h6>
                                </div>
                                <div class="card-body" id="pendingInvitesSection">
                                    <div class="text-center py-2">
                                        <i class="fas fa-spinner fa-spin"></i> Loading invitations...
                                    </div>
                                </div>
                            </div>

                            <!-- Active Users -->
                            <div class="card mb-4">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-user-check me-2"></i>Active Users
                                    </h6>
                                </div>
                                <div class="card-body p-0" id="activeUsersSection">
                                    <div class="text-center py-2">
                                        <i class="fas fa-spinner fa-spin"></i> Loading active users...
                                    </div>
                                </div>
                            </div>

                            <!-- Team Information -->
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-info-circle me-2"></i>Organization Information
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Organization Name</label>
                                                <p class="fw-semibold">{{ tenant.name }}</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Your Role</label>
                                                <p class="fw-semibold">{{ 'Administrator' if user.is_admin else 'Member' }}</p>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Brand Voice Limit</label>
                                                <p class="fw-semibold">{{ company_brand_voices|length }} / {{ tenant.max_brand_voices }} Company Voices</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Organization Type</label>
                                                <p class="fw-semibold">{{ 'Company' if tenant.tenant_type.value == 'company' else 'Individual Account' }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Invitations Tab -->
                        <div class="tab-pane fade" id="invitations" role="tabpanel">
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <h6 class="text-primary mb-3">Invitation Statistics</h6>
                                    <div class="row g-3" id="invitationStats">
                                        <div class="col-md-4">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <i class="fas fa-paper-plane text-primary mb-2" style="font-size: 2rem;"></i>
                                                    <h5 id="totalSent">-</h5>
                                                    <p class="text-muted">Invitations Sent</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <i class="fas fa-user-check text-success mb-2" style="font-size: 2rem;"></i>
                                                    <h5 id="acceptedCount">-</h5>
                                                    <p class="text-muted">Accepted</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <i class="fas fa-clock text-warning mb-2" style="font-size: 2rem;"></i>
                                                    <h5 id="pendingCount">-</h5>
                                                    <p class="text-muted">Pending</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pending Invitations -->
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-envelope me-2"></i>Pending Invitations
                                    </h6>
                                </div>
                                <div class="card-body" id="pendingInvitationsSection">
                                    <div class="text-center py-2">
                                        <i class="fas fa-spinner fa-spin"></i> Loading invitations...
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Billing Tab (for individual users only) -->
                        {% if tenant.tenant_type.value == 'independent_user' %}
                        <div class="tab-pane fade" id="billing" role="tabpanel">
                            <h6 class="text-primary mb-3">Billing Information</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label text-muted">Current Plan</label>
                                        <p class="fw-semibold">{{ user.subscription_level.value.title() }}</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label text-muted">Brand Voice Limit</label>
                                        <p class="fw-semibold">
                                            {% if user.subscription_level.value == 'solo' %}1 Voice{% elif user.subscription_level.value == 'pro' %}10 Voices{% else %}{{ max_user_voices }} Voices{% endif %}
                                        </p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Billing Management</strong><br>
                                        Contact support for billing inquiries and plan changes.
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Account Deletion Section -->
                            <hr class="my-4">
                            <div class="row">
                                <div class="col-12">
                                    <h6 class="text-danger mb-3">
                                        <i class="fas fa-exclamation-triangle me-2"></i>Danger Zone
                                    </h6>
                                    <div class="alert alert-danger">
                                        <h6 class="alert-heading">Delete Account</h6>
                                        <p class="mb-3">
                                            Permanently delete your account and all associated data. This action cannot be undone.
                                        </p>
                                        <ul class="mb-3">
                                            <li>All your brand voices will be permanently deleted</li>
                                            <li>Your account information will be removed</li>
                                            <li>You will lose access to all content and data</li>
                                        </ul>
                                        <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                                            <i class="fas fa-trash me-2"></i>Delete Account
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editProfileForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editFirstName" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="editFirstName" value="{{ user.first_name }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editLastName" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="editLastName" value="{{ user.last_name }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="editEmail" value="{{ user.email }}" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Change Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="changePasswordForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="currentPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="newPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirmPassword" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Change Password</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Invite Team Member Modal -->
<div class="modal fade" id="inviteTeamMemberModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Invite Team Member</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="inviteTeamMemberForm">
                    <div class="mb-3">
                        <label for="inviteEmail" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="inviteEmail" required 
                               placeholder="Enter team member's email address">
                        <div class="form-text">
                            The team member will receive an invitation email to join {{ tenant.name }}.
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>What happens next:</strong><br>
                        • An invitation email will be sent to the provided address<br>
                        • If they have a GoldenDoodleLM account, they'll be added to your organization<br>
                        • If not, they'll be guided through creating an account<br>
                        • The invitation expires after 7 days
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="sendInviteBtn">
                    <i class="fas fa-paper-plane me-1"></i>Send Invitation
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Invite Friends Modal -->
<div class="modal fade" id="inviteFriendsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-friends me-2"></i>Invite Friends to GoldenDoodleLM
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="inviteFriendsForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="inviteEmails" class="form-label">Email Addresses</label>
                        <textarea 
                            class="form-control" 
                            id="inviteEmails" 
                            rows="4" 
                            placeholder="Enter email addresses (one per line or comma-separated)&#10;&#10;colleague@company.com&#10;friend@example.com&#10;partner@organization.org"
                            required></textarea>
                        <div class="form-text">
                            Enter email addresses separated by commas or new lines.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="invitationType" class="form-label">Relationship</label>
                        <select class="form-select" id="invitationType">
                            <option value="colleague">Colleague</option>
                            <option value="friend">Friend</option>
                            <option value="partner_organization">Partner Organization</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="personalMessage" class="form-label">Personal Message (Optional)</label>
                        <textarea 
                            class="form-control" 
                            id="personalMessage" 
                            rows="3" 
                            placeholder="Add a personal note to your invitation..."></textarea>
                        <div class="form-text">
                            This message will be included in the invitation email.
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>How it works:</strong><br>
                        • Each person will receive a personalized invitation email from you<br>
                        • They'll get a unique invitation code to register<br>
                        • You can track who has accepted your invitations<br>
                        • Help grow the GoldenDoodleLM community!
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="sendInvitesBtn">
                        <i class="fas fa-paper-plane me-1"></i>Send Invitations
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Invitation Results Modal -->
<div class="modal fade" id="invitationResultsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Invitation Results
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="invitationResultsContent">
                <!-- Results will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header border-danger">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Delete Account
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="deleteAccountForm">
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <h6 class="alert-heading">
                            <i class="fas fa-warning me-2"></i>This action is permanent and cannot be undone!
                        </h6>
                        <p class="mb-0">
                            All your data, including brand voices and account information, will be permanently deleted.
                        </p>
                    </div>
                    
                    <div class="mb-3">
                        <label for="confirmEmail" class="form-label">
                            To confirm, please enter your email address:
                        </label>
                        <input type="email" class="form-control" id="confirmEmail" placeholder="{{ user.email }}" required>
                        <div class="form-text">Enter your email exactly as shown above</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="deleteReason" class="form-label">
                            Why are you deleting your account? (Optional)
                        </label>
                        <textarea class="form-control" id="deleteReason" rows="3" placeholder="Help us improve by letting us know why you're leaving..."></textarea>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="confirmDeletion" required>
                        <label class="form-check-label" for="confirmDeletion">
                            I understand that this action is permanent and cannot be undone
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger" disabled id="deleteAccountBtn">
                        <i class="fas fa-trash me-2"></i>Delete My Account
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load pending invites and active users if team management tab exists
    if (document.getElementById('team-management')) {
        loadPendingInvites();
        loadActiveUsers();
    }

    // Load invitation statistics
    loadInvitationStats();

    // Handle invite friends form
    document.getElementById('inviteFriendsForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const emails = document.getElementById('inviteEmails').value.trim();
        const invitationType = document.getElementById('invitationType').value;
        const personalMessage = document.getElementById('personalMessage').value.trim();

        if (!emails) {
            alert('Please enter at least one email address');
            return;
        }

        const sendBtn = document.getElementById('sendInvitesBtn');
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';

        fetch('/send-user-invitations', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                emails: emails,
                invitation_type: invitationType,
                personal_message: personalMessage
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show results modal
                showInvitationResults(data.results, data.total_sent);
                
                // Reset form
                document.getElementById('inviteFriendsForm').reset();
                
                // Hide invite modal
                bootstrap.Modal.getInstance(document.getElementById('inviteFriendsModal')).hide();
                
                // Reload invitation stats
                loadInvitationStats();
            } else {
                alert('Failed to send invitations: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to send invitations');
        })
        .finally(() => {
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send Invitations';
        });
    });

    // Handle send team member invitation
    const sendInviteBtn = document.getElementById('sendInviteBtn');
    if (sendInviteBtn) {
        sendInviteBtn.addEventListener('click', function() {
            const email = document.getElementById('inviteEmail').value.trim();
            
            if (!email) {
                alert('Please enter an email address');
                return;
            }

            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';

            fetch('/send-organization-invite', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: email
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    document.getElementById('inviteEmail').value = '';
                    bootstrap.Modal.getInstance(document.getElementById('inviteTeamMemberModal')).hide();
                    loadPendingInvites(); // Refresh pending invites
                } else {
                    alert('Failed to send invitation: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to send invitation');
            })
            .finally(() => {
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send Invitation';
            });
        });
    }

    function loadPendingInvites() {
        const pendingSection = document.getElementById('pendingInvitesSection');
        if (!pendingSection) return;

        const tenantId = '{{ tenant.tenant_id }}';
        
        fetch(`/get-pending-invites/${tenantId}`)
        .then(response => response.json())
        .then(data => {
            if (data.invites && data.invites.length > 0) {
                let html = '<div class="table-responsive"><table class="table table-sm mb-0">';
                html += '<thead><tr><th>Email</th><th>Invited By</th><th>Sent</th></tr></thead><tbody>';
                
                data.invites.forEach(invite => {
                    const sentDate = new Date(invite.created_at).toLocaleDateString();
                    html += `<tr>
                        <td>${invite.email}</td>
                        <td>${invite.invited_by}</td>
                        <td>${sentDate}</td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
                pendingSection.innerHTML = html;
            } else {
                pendingSection.innerHTML = '<div class="text-center py-2 text-muted">No pending invitations</div>';
            }
        })
        .catch(error => {
            console.error('Error loading pending invites:', error);
            pendingSection.innerHTML = 
                '<div class="text-center py-2 text-danger">Failed to load pending invitations</div>';
        });
    }

    function loadActiveUsers() {
        const activeUsersSection = document.getElementById('activeUsersSection');
        if (!activeUsersSection) return;

        const tenantId = '{{ tenant.tenant_id }}';
        
        fetch(`/get-active-users/${tenantId}`)
        .then(response => response.json())
        .then(data => {
            if (data.users && data.users.length > 0) {
                let html = '<div class="table-responsive"><table class="table table-striped mb-0">';
                html += `<thead class="table-light">
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Access Level</th>
                        <th>Status</th>
                        <th>Last Login</th>
                        <th>Member Since</th>
                    </tr>
                </thead><tbody>`;
                
                data.users.forEach(user => {
                    const lastLogin = user.last_login ? 
                        new Date(user.last_login).toLocaleDateString() + ' ' + 
                        new Date(user.last_login).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}) :
                        '<span class="text-muted">Never</span>';
                    
                    const memberSince = user.created_at ? 
                        new Date(user.created_at).toLocaleDateString() : 'N/A';
                    
                    const adminCrown = user.is_admin ? 
                        ' <i class="fas fa-crown text-warning ms-1" title="Administrator"></i>' : '';
                    
                    const accessLevel = user.is_admin ?
                        '<span class="badge bg-warning text-dark">Administrator</span>' :
                        '<span class="badge bg-secondary">User</span>';
                    
                    const status = user.email_verified ?
                        '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Active</span>' :
                        '<span class="badge bg-warning"><i class="fas fa-exclamation me-1"></i>Pending</span>';
                    
                    html += `<tr>
                        <td>${user.first_name} ${user.last_name}${adminCrown}</td>
                        <td>${user.email}</td>
                        <td>${accessLevel}</td>
                        <td>${status}</td>
                        <td>${lastLogin}</td>
                        <td>${memberSince}</td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
                activeUsersSection.innerHTML = html;
            } else {
                activeUsersSection.innerHTML = '<div class="text-center py-2 text-muted">No active users found</div>';
            }
        })
        .catch(error => {
            console.error('Error loading active users:', error);
            activeUsersSection.innerHTML = 
                '<div class="text-center py-2 text-danger">Failed to load active users</div>';
        });
    }

    // Edit Profile Form
    document.getElementById('editProfileForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = {
            first_name: document.getElementById('editFirstName').value,
            last_name: document.getElementById('editLastName').value,
            email: document.getElementById('editEmail').value
        };

        fetch('/update-profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'An error occurred while updating your profile.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating your profile.');
        });
    });

    // Change Password Form
    document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
            alert('New passwords do not match.');
            return;
        }

        const formData = {
            current_password: document.getElementById('currentPassword').value,
            new_password: newPassword
        };

        fetch('/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Password changed successfully!');
                document.getElementById('changePasswordModal').querySelector('.btn-close').click();
                document.getElementById('changePasswordForm').reset();
            } else {
                alert(data.error || 'An error occurred while changing your password.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while changing your password.');
        });
    });

    // Delete Account Form Validation
    const confirmEmailInput = document.getElementById('confirmEmail');
    const confirmDeletionCheckbox = document.getElementById('confirmDeletion');
    const deleteAccountBtn = document.getElementById('deleteAccountBtn');
    const userEmail = '{{ user.email }}';

    function loadInvitationStats() {
        fetch('/my-invitations')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalSent').textContent = data.total_sent || 0;
            document.getElementById('acceptedCount').textContent = data.accepted_count || 0;
            document.getElementById('pendingCount').textContent = data.pending_count || 0;

            // Load pending invitations
            const pendingSection = document.getElementById('pendingInvitationsSection');
            if (data.pending_invitations && data.pending_invitations.length > 0) {
                let html = '<div class="table-responsive"><table class="table table-sm mb-0">';
                html += '<thead><tr><th>Email</th><th>Invitation Code</th><th>Sent Date</th></tr></thead><tbody>';
                
                data.pending_invitations.forEach(invite => {
                    const sentDate = new Date(invite.created_at).toLocaleDateString();
                    html += `<tr>
                        <td>${invite.email}</td>
                        <td><code>${invite.invite_code}</code></td>
                        <td>${sentDate}</td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
                pendingSection.innerHTML = html;
            } else {
                pendingSection.innerHTML = '<div class="text-center py-3 text-muted">No pending invitations</div>';
            }
        })
        .catch(error => {
            console.error('Error loading invitation stats:', error);
            document.getElementById('pendingInvitationsSection').innerHTML = 
                '<div class="text-center py-3 text-danger">Failed to load invitation statistics</div>';
        });
    }

    function showInvitationResults(results, totalSent) {
        let html = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                <strong>Invitations Sent!</strong> ${totalSent} invitation${totalSent !== 1 ? 's' : ''} sent successfully.
            </div>
        `;

        if (results.length > 0) {
            html += '<div class="table-responsive"><table class="table table-sm">';
            html += '<thead><tr><th>Email</th><th>Status</th><th>Invitation Code</th></tr></thead><tbody>';
            
            results.forEach(result => {
                const statusIcon = result.success ? 
                    '<i class="fas fa-check-circle text-success"></i>' : 
                    '<i class="fas fa-exclamation-circle text-danger"></i>';
                
                const statusText = result.success ? 
                    (result.email_sent ? 'Sent' : 'Created (Email failed)') : 
                    result.error;
                
                const inviteCode = result.invite_code ? 
                    `<code>${result.invite_code}</code>` : 
                    '-';
                
                html += `<tr>
                    <td>${result.email}</td>
                    <td>${statusIcon} ${statusText}</td>
                    <td>${inviteCode}</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
        }

        document.getElementById('invitationResultsContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('invitationResultsModal')).show();
    }

    function validateDeleteForm() {
        const emailMatches = confirmEmailInput.value === userEmail;
        const checkboxChecked = confirmDeletionCheckbox.checked;
        deleteAccountBtn.disabled = !(emailMatches && checkboxChecked);
    }

    confirmEmailInput.addEventListener('input', validateDeleteForm);
    confirmDeletionCheckbox.addEventListener('change', validateDeleteForm);

    // Delete Account Form
    document.getElementById('deleteAccountForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const confirmEmail = document.getElementById('confirmEmail').value;
        const deleteReason = document.getElementById('deleteReason').value;

        if (confirmEmail !== userEmail) {
            alert('Email address does not match.');
            return;
        }

        if (!confirm('Are you absolutely sure? This action cannot be undone and will permanently delete all your data.')) {
            return;
        }

        const formData = {
            confirm_email: confirmEmail,
            delete_reason: deleteReason
        };

        // Disable the button to prevent double-clicks
        deleteAccountBtn.disabled = true;
        deleteAccountBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Deleting...';

        fetch('/delete-account', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Your account has been successfully deleted. You will now be redirected to the home page.');
                window.location.href = '/';
            } else {
                alert(data.error || 'An error occurred while deleting your account.');
                deleteAccountBtn.disabled = false;
                deleteAccountBtn.innerHTML = '<i class="fas fa-trash me-2"></i>Delete My Account';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting your account.');
            deleteAccountBtn.disabled = false;
            deleteAccountBtn.innerHTML = '<i class="fas fa-trash me-2"></i>Delete My Account';
        });
    });
});
</script>
{% endblock %}