
{% extends "base.html" %}

{% block title %}Resend Beta Invitations - Admin{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0"><i class="fas fa-paper-plane me-2"></i>Resend Beta Invitations</h3>
                    <a href="/admin/beta-invites" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus me-1"></i>Send New Invites
                    </a>
                </div>
                <div class="card-body">
                    <!-- Statistics -->
                    <div class="row mb-4" id="stats-section">
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 id="total-invites" class="mb-0">-</h4>
                                    <small class="text-muted">Total Invites</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h4 id="pending-invites" class="mb-0">-</h4>
                                    <small>Pending</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h4 id="accepted-invites" class="mb-0">-</h4>
                                    <small>Accepted</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h4 id="acceptance-rate" class="mb-0">-</h4>
                                    <small>Acceptance Rate</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pending Invitations Table -->
                    <div class="table-responsive">
                        <table class="table table-hover" id="invitations-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all"></th>
                                    <th>Email</th>
                                    <th>Organization</th>
                                    <th>Code</th>
                                    <th>Created</th>
                                    <th>Age (days)</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="invitations-body">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="spinner-border spinner-border-sm me-2" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        Loading invitations...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Bulk Actions -->
                    <div class="mt-3">
                        <button class="btn btn-primary" id="resend-selected" disabled>
                            <i class="fas fa-envelope me-1"></i>Resend Selected
                        </button>
                        <button class="btn btn-secondary" id="refresh-list">
                            <i class="fas fa-sync me-1"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resend Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="results-content">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
let invitations = [];

function loadInvitations() {
    fetch('/admin/api/pending-beta-invites')
        .then(response => response.json())
        .then(data => {
            invitations = data.invitations;
            updateStats(data.stats);
            renderInvitations();
        })
        .catch(error => {
            console.error('Error loading invitations:', error);
            document.getElementById('invitations-body').innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>Error loading invitations
                    </td>
                </tr>
            `;
        });
}

function updateStats(stats) {
    document.getElementById('total-invites').textContent = stats.total_invitations;
    document.getElementById('pending-invites').textContent = stats.pending_invitations;
    document.getElementById('accepted-invites').textContent = stats.accepted_invitations;
    document.getElementById('acceptance-rate').textContent = stats.acceptance_rate + '%';
}

function renderInvitations() {
    const tbody = document.getElementById('invitations-body');
    
    if (invitations.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted">
                    <i class="fas fa-inbox me-2"></i>No pending invitations found
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = invitations.map((inv, index) => {
        const createdDate = new Date(inv.created_at);
        const ageInDays = Math.floor((Date.now() - createdDate.getTime()) / (1000 * 60 * 60 * 24));
        const statusBadge = inv.status === 'pending' ? 'bg-warning' : inv.status === 'accepted' ? 'bg-success' : 'bg-secondary';
        
        return `
            <tr>
                <td><input type="checkbox" class="invite-checkbox" data-email="${inv.invitee_email}"></td>
                <td>${inv.invitee_email}</td>
                <td>${inv.organization_name}</td>
                <td><code>${inv.invite_code}</code></td>
                <td>${createdDate.toLocaleDateString()}</td>
                <td>${ageInDays}</td>
                <td><span class="badge ${statusBadge}">${inv.status}</span></td>
                <td>
                    <button class="btn btn-sm btn-primary resend-btn" data-email="${inv.invitee_email}">
                        <i class="fas fa-paper-plane"></i> Resend
                    </button>
                </td>
            </tr>
        `;
    }).join('');

    // Attach event listeners
    document.querySelectorAll('.resend-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            resendInvites([this.dataset.email]);
        });
    });

    document.querySelectorAll('.invite-checkbox').forEach(cb => {
        cb.addEventListener('change', updateBulkActionButtons);
    });
}

function updateBulkActionButtons() {
    const checkedBoxes = document.querySelectorAll('.invite-checkbox:checked');
    document.getElementById('resend-selected').disabled = checkedBoxes.length === 0;
}

function resendInvites(emails) {
    const btn = event ? event.target.closest('button') : null;
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Sending...';
    }

    fetch('/admin/api/resend-beta-invites', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ emails: emails })
    })
    .then(response => response.json())
    .then(data => {
        showResults(data.results);
        loadInvitations(); // Refresh the list
    })
    .catch(error => {
        console.error('Error resending invites:', error);
        alert('Error resending invitations. Please try again.');
    })
    .finally(() => {
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane"></i> Resend';
        }
    });
}

function showResults(results) {
    const content = document.getElementById('results-content');
    const successCount = results.filter(r => r.success).length;
    const failCount = results.length - successCount;

    content.innerHTML = `
        <div class="alert alert-info">
            <strong>Results:</strong> ${successCount} sent successfully, ${failCount} failed
        </div>
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Message</th>
                </tr>
            </thead>
            <tbody>
                ${results.map(r => `
                    <tr class="${r.success ? 'table-success' : 'table-danger'}">
                        <td>${r.email}</td>
                        <td><i class="fas fa-${r.success ? 'check-circle text-success' : 'times-circle text-danger'}"></i></td>
                        <td>${r.message || (r.success ? 'Sent successfully' : r.error)}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;

    new bootstrap.Modal(document.getElementById('resultsModal')).show();
}

// Event listeners
document.getElementById('select-all').addEventListener('change', function() {
    document.querySelectorAll('.invite-checkbox').forEach(cb => {
        cb.checked = this.checked;
    });
    updateBulkActionButtons();
});

document.getElementById('resend-selected').addEventListener('click', function() {
    const emails = Array.from(document.querySelectorAll('.invite-checkbox:checked'))
        .map(cb => cb.dataset.email);
    
    if (confirm(`Resend invitations to ${emails.length} recipient(s)?`)) {
        resendInvites(emails);
    }
});

document.getElementById('refresh-list').addEventListener('click', loadInvitations);

// Load on page load
loadInvitations();
</script>
{% endblock %}
