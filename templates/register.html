{% extends "base.html" %}

{% block title %}Sign Up - GoldenDoodleLM{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center py-5">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow-lg border-0">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="GoldenDoodleLM Logo" class="logo mb-3">
                        <h2 class="fw-bold">Create Your Account</h2>
                        {% if config.get('STRIPE_DISABLED', '').lower() == 'true' %}
                        <div class="alert alert-info">
                            <i class="fas fa-rocket me-2"></i>
                            <strong>Beta Access:</strong> All plans are currently free during our beta period!
                        </div>
                        {% endif %}
                        <p class="text-muted">Join GoldenDoodleLM and transform your content creation</p>
                    </div>

                    <form method="POST" id="registerForm">
                        {% if invitation_code %}
                        <input type="hidden" name="invitation_code" value="{{ invitation_code }}">
                        {% endif %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="first_name" class="form-label fw-semibold">First Name</label>
                                    <input type="text" class="form-control" id="first_name" name="first_name"
                                           placeholder="Enter your first name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="last_name" class="form-label fw-semibold">Last Name</label>
                                    <input type="text" class="form-control" id="last_name" name="last_name"
                                           placeholder="Enter your last name" required>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label fw-semibold">Email Address</label>
                            <input type="email" class="form-control" id="email" name="email"
                                   placeholder="Enter your email"
                                   value="{{ invitation_data.invitee_email if invitation_data else '' }}"
                                   {% if invitation_data %}readonly{% endif %}
                                   required>
                            {% if invitation_data %}
                            <small class="text-muted">This email was pre-filled from your invitation.</small>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="password" class="form-label fw-semibold">Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="password" name="password"
                                       placeholder="Create a secure password" required>
                                <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                    <i class="fas fa-eye" id="passwordToggleIcon"></i>
                                </button>
                            </div>
                        </div>

                        {% if not is_organization_invite %}
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Account Type</label>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <div class="card account-type-card" data-type="independent">
                                        <div class="card-body text-center p-3">
                                            <i class="fas fa-user text-primary mb-2"></i>
                                            <h6 class="fw-bold">Individual</h6>
                                            <small class="text-muted">Personal account</small>
                                            <input type="radio" name="user_type" value="independent" class="d-none" {% if not invitation_data %}checked{% endif %}>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card account-type-card" data-type="company">
                                        <div class="card-body text-center p-3">
                                            <i class="fas fa-building text-primary mb-2"></i>
                                            <h6 class="fw-bold">Organization</h6>
                                            <small class="text-muted">Team account</small>
                                            <input type="radio" name="user_type" value="company" class="d-none" {% if invitation_data %}checked{% endif %}>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3" id="organizationField" style="{% if invitation_data %}display: block;{% else %}display: none;{% endif %}">
                            <label for="organization_name" class="form-label fw-semibold">Organization Name</label>
                            <input type="text" class="form-control" id="organization_name" name="organization_name"
                                   placeholder="Enter your organization name"
                                   value="{{ invitation_data.organization_name if invitation_data else '' }}"
                                   {% if invitation_data %}readonly{% endif %}>
                            {% if invitation_data %}
                            <small class="text-muted">This organization name was pre-filled from your invitation.</small>
                            {% endif %}
                        </div>
                        {% endif %}

                        {% if is_organization_invite %}
                        <div class="mb-4">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                You're joining <strong>{{ organization_invite.organization_name }}</strong> as a team member.
                                Your account will be automatically configured with the appropriate access level.
                            </div>
                        </div>
                        {% elif invitation_data and invitation_data.invitation_type == 'beta' %}
                        <div class="mb-4">
                            <div class="alert alert-primary">
                                <h6 class="alert-heading"><i class="fas fa-crown me-2"></i>Beta Invitation - Organization Account</h6>
                                <p class="mb-2">You're signing up for an <strong>Organization account</strong> with these beta benefits:</p>
                                <ul class="mb-2">
                                    <li>✅ 90-day free trial of "The Organization" plan</li>
                                    <li>✅ Full access to all premium features</li>
                                    <li>✅ Ability to invite team members (they get free access too!)</li>
                                    <li>✅ Up to 10 brand voices</li>
                                    <li>✅ No payment required during beta</li>
                                </ul>
                                <small class="text-muted">
                                    <strong>Organization:</strong> {{ invitation_data.organization_name }}<br>
                                    <strong>Invited Email:</strong> {{ invitation_data.invitee_email }}
                                </small>
                            </div>
                        </div>
                        {% elif invitation_data %}
                        <div class="mb-4">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Invitation Details:</strong><br>
                                • Organization: {{ invitation_data.organization_name }}<br>
                                • Type: {{ invitation_data.invitation_type.title() }} invitation<br>
                                • Email: {{ invitation_data.invitee_email }}<br>
                                • Created: {{ invitation_data.created_at[:10] }}
                            </div>
                        </div>
                        {% else %}
                        <div class="mb-4" id="subscriptionPlans">
                            <label class="form-label fw-semibold">Choose Your Plan</label>

                            <!-- Loading indicator for plans -->
                            <div id="plansLoadingIndicator" class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Loading plans...</span>
                                </div>
                                <p class="small text-muted mt-2">Loading pricing plans...</p>
                            </div>

                            <!-- Individual Plans -->
                            <div id="individualPlans">
                                <h6 class="text-primary mb-2">Individual Plans</h6>
                                <div class="row g-3 mb-4" id="individualPlansContainer">
                                    <!-- Plans will be loaded dynamically -->
                                </div>
                            </div>

                            <!-- Team Plans -->
                            <div id="teamPlans" style="display: none;">
                                <h6 class="text-primary mb-2">Team Plans</h6>
                                <div class="row g-3 mb-4" id="teamPlansContainer">
                                    <!-- Plans will be loaded dynamically -->
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <button type="submit" class="btn btn-primary w-100 mb-3" id="submitBtn">
                            <i class="fas fa-rocket me-2"></i>Create Account
                        </button>

                        <!-- Loading state for payment processing -->
                        <div id="paymentLoading" style="display: none;" class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Processing payment...</span>
                            </div>
                            <p class="small text-muted mt-2">Redirecting to secure payment...</p>
                        </div>
                    </form>

                    <div class="text-center">
                        <p class="text-muted mb-0">
                            Already have an account?
                            <a href="{{ url_for('login') }}" class="text-primary text-decoration-none fw-semibold">
                                Sign in here
                            </a>
                        </p>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4">
                <small class="text-muted">
                    <i class="fas fa-shield-alt me-1"></i>
                    Your data is secure and private. We never train on your content.
                </small>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Skip JavaScript setup for organization invites
    const isOrgInvite = {{ 'true' if is_organization_invite else 'false' }};
    const hasInvitation = {{ 'true' if invitation_data else 'false' }};
    const stripeDisabled = {{ 'true' if config.get('STRIPE_DISABLED', '').lower() == 'true' else 'false' }};
    const invitationType = "{{ invitation_data.invitation_type if invitation_data else '' }}";

    if (isOrgInvite || invitationType === 'beta') {
        // If it's an organization invite or a beta invite, force organization account type
        const orgField = document.getElementById('organizationField');
        if (orgField) {
            orgField.style.display = 'block';
            document.getElementById('organization_name').required = true;
        }

        // Hide individual plans and show team plans
        document.getElementById('individualPlans').style.display = 'none';
        document.getElementById('teamPlans').style.display = 'block';

        // Check the correct radio buttons
        if (hasInvitation) {
            const companyRadio = document.querySelector('input[name="user_type"][value="company"]');
            if (companyRadio) {
                companyRadio.checked = true;
            }
            const teamCard = document.querySelector('.subscription-card[data-level="team"]');
            if (teamCard) {
                teamCard.classList.add('selected');
                const teamRadio = teamCard.querySelector('input[type="radio"]');
                if (teamRadio) {
                    teamRadio.checked = true;
                }
            }
        } else {
            // If it's not an invitation but we are forcing org type (e.g., beta invite flow)
            const companyRadio = document.querySelector('input[name="user_type"][value="company"]');
            if (companyRadio) {
                companyRadio.checked = true;
            }
            // Select the team plan by default for beta users
            setTimeout(() => {
                const teamCard = document.querySelector('[data-level="team"]');
                if (teamCard) {
                    teamCard.click();
                }
            }, 100);
        }

        // If it's a beta invite, disable individual plan selection
        if (invitationType === 'beta') {
            document.querySelectorAll('.account-type-card').forEach(card => {
                if (card.getAttribute('data-type') === 'independent') {
                    card.style.pointerEvents = 'none';
                    card.style.opacity = '0.6';
                }
            });
        }

        // If it's a beta invite, we skip the rest of the plan loading and selection logic
        if (invitationType === 'beta') {
            return;
        }
    }


    let plansData = [];

    // Helper function to display errors
    function showError(message) {
        const paymentLoadingDiv = document.getElementById('paymentLoading');
        paymentLoadingDiv.innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Error:</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        paymentLoadingDiv.style.display = 'block';
        document.getElementById('submitBtn').style.display = 'block'; // Show submit button again
    }

    // Helper function to enable form and hide loading spinner
    function enableForm() {
        document.getElementById('paymentLoading').style.display = 'none';
        document.getElementById('submitBtn').style.display = 'block';
    }

    // Helper function to hide error messages and show loading spinner
    function hideError() {
        document.getElementById('paymentLoading').style.display = 'none';
    }

    // Load pricing plans
    async function loadPlans() {
        try {
            const response = await fetch('/api/get-plans');
            if (!response.ok) {
                throw new Error('Failed to load plans');
            }

            plansData = await response.json();
            renderPlans();
            document.getElementById('plansLoadingIndicator').style.display = 'none';
        } catch (error) {
            console.error('Error loading plans:', error);
            document.getElementById('plansLoadingIndicator').innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Failed to load pricing plans. Please refresh the page.
                </div>
            `;
        }
    }

    function renderPlans() {
        const individualContainer = document.getElementById('individualPlansContainer');
        const teamContainer = document.getElementById('teamPlansContainer');

        // Clear containers
        individualContainer.innerHTML = '';
        teamContainer.innerHTML = '';

        // Individual plans: free, solo, professional
        const individualPlans = plansData.filter(plan => ['free', 'solo', 'professional'].includes(plan.plan_id));
        individualPlans.forEach(plan => {
            individualContainer.appendChild(createPlanCard(plan));
        });

        // Team plans: team only
        const teamPlans = plansData.filter(plan => ['team'].includes(plan.plan_id));
        teamPlans.forEach(plan => {
            teamContainer.appendChild(createPlanCard(plan));
        });
    }

    function createPlanCard(plan) {
        const col = document.createElement('div');
        col.className = 'col-md-6';

        // Determine pricing display
        let priceDisplay, badgeClass, trialText;
        if (plan.plan_id === 'free') {
            priceDisplay = 'Free';
            badgeClass = 'bg-success';
            trialText = 'Always Free';
        } else if (plan.plan_id === 'team') {
            priceDisplay = `$${plan.price_monthly}/user/mo`;
            badgeClass = 'bg-info';
            trialText = '7-Day Free Trial';
        } else {
            priceDisplay = `$${plan.price_monthly}/mo`;
            badgeClass = plan.plan_id === 'solo' ? 'bg-success' : 'bg-warning';
            trialText = '7-Day Free Trial';
        }

        // Get features
        const features = getPlanFeatures(plan);

        col.innerHTML = `
            <div class="card subscription-card h-100" data-level="${plan.plan_id}">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="fw-bold text-primary">${plan.name}</h6>
                        <span class="badge ${badgeClass}">${priceDisplay}</span>
                    </div>
                    ${plan.plan_id !== 'free' ? `
                    <div class="text-center mb-2">
                        <small class="badge bg-light text-dark border">
                            <i class="fas fa-gift me-1"></i>${trialText}
                        </small>
                    </div>
                    ` : ''}
                    <p class="small text-muted mb-2">${plan.target_user}</p>
                    <ul class="list-unstyled small mb-0">
                        ${features.map(feature => `
                            <li>
                                <i class="fas fa-${feature.available ? 'check text-success' : 'times text-muted'} me-1"></i>
                                ${feature.text}
                            </li>
                        `).join('')}
                    </ul>
                    <input type="radio" name="subscription_level" value="${plan.plan_id}" class="d-none">
                </div>
            </div>
        `;

        return col;
    }

    function getPlanFeatures(plan) {
        const features = [];

        // User seats
        if (plan.plan_id === 'team') {
            features.push({ text: 'Minimum 3 User Seats', available: true });
        } else {
            features.push({ text: '1 User Seat', available: true });
        }

        // Brand voices
        if (plan.brand_voices > 0) {
            const voiceText = plan.brand_voices === 1 ? '1 Brand Voice' : `Up to ${plan.brand_voices} Brand Voices`;
            features.push({ text: voiceText, available: true });
        }

        // Templates
        if (plan.templates === 'full') {
            features.push({ text: 'Full Template Library', available: true });
        } else if (plan.templates === 'basic') {
            features.push({ text: 'Basic Templates', available: true });
        }

        // Analysis & brainstorming
        if (plan.analysis_brainstorm) {
            features.push({ text: 'Analysis & Brainstorm Tools', available: true });
        }

        // Admin controls for team plans
        if (plan.admin_controls) {
            features.push({ text: 'Admin Controls & User Management', available: true });
        }

        // Support
        const supportLevels = {
            'none': 'Community Support',
            'email': 'Email Support',
            'priority': 'Priority Support'
        };

        features.push({
            text: supportLevels[plan.support_level] || 'Support',
            available: plan.support_level !== 'none'
        });

        return features;
    }

    // Account type selection
    const accountTypeCards = document.querySelectorAll('.account-type-card');
    const organizationField = document.getElementById('organizationField');
    const individualPlansDiv = document.getElementById('individualPlans');
    const teamPlansDiv = document.getElementById('teamPlans');

    accountTypeCards.forEach(card => {
        card.addEventListener('click', function() {
            accountTypeCards.forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');

            const radio = this.querySelector('input[type="radio"]');
            radio.checked = true;

            if (radio.value === 'company') {
                organizationField.style.display = 'block';
                document.getElementById('organization_name').required = true;
                individualPlansDiv.style.display = 'none';
                teamPlansDiv.style.display = 'block';

                // Select team plan by default for organizations
                setTimeout(() => {
                    const teamCard = document.querySelector('[data-level="team"]');
                    if (teamCard) {
                        teamCard.click();
                    }
                }, 100);
            } else {
                organizationField.style.display = 'none';
                document.getElementById('organization_name').required = false;
                individualPlansDiv.style.display = 'block';
                teamPlansDiv.style.display = 'none';

                // Select free plan by default for individuals
                setTimeout(() => {
                    const freeCard = document.querySelector('[data-level="free"]');
                    if (freeCard) {
                        freeCard.click();
                    }
                }, 100);
            }
        });
    });

    // Subscription level selection (delegated event handling)
    document.addEventListener('click', function(e) {
        const subscriptionCard = e.target.closest('.subscription-card');
        if (subscriptionCard) {
            document.querySelectorAll('.subscription-card').forEach(c => c.classList.remove('selected'));
            subscriptionCard.classList.add('selected');

            const radio = subscriptionCard.querySelector('input[type="radio"]');
            if (radio) {
                radio.checked = true;
            }
        }
    });

    // Form submission handling
    const registerForm = document.getElementById('registerForm');
    const submitBtn = document.getElementById('submitBtn');
    const paymentLoading = document.getElementById('paymentLoading');

    registerForm.addEventListener('submit', async function(e) {
        const selectedPlan = document.querySelector('input[name="subscription_level"]:checked');

        // If Stripe is disabled, or the selected plan is free, submit directly.
        if (stripeDisabled || (selectedPlan && selectedPlan.value === 'free')) {
            // If Stripe is disabled, we don't need to prevent default for paid plans either
            // because they will be handled differently or not offered.
            // The form will submit normally.
            return;
        }

        // If Stripe is enabled and a paid plan is selected, proceed with Stripe checkout.
        if (selectedPlan && ['solo', 'team', 'professional'].includes(selectedPlan.value)) {
            e.preventDefault(); // Prevent default form submission for paid plans

            // Show loading state for paid plans
            submitBtn.style.display = 'none';
            paymentLoading.style.display = 'block';
            paymentLoading.innerHTML = `
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Processing payment...</span>
                </div>
                <p class="small text-muted mt-2">Redirecting to secure payment...</p>
            `;

            try {
                // Submit form data via fetch
                const formData = new FormData(registerForm);

                console.log('Submitting registration form...');

                const response = await fetch('/register', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json'
                    },
                    body: formData
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers.get('content-type'));

                // Check if this is a redirect to login page (successful registration)
                const contentType = response.headers.get('content-type');
                if (response.status === 200 && contentType && contentType.includes('text/html')) {
                    // This is likely a successful registration that redirected to login
                    console.log('✓ Registration successful - redirecting to login');
                    window.location.href = '/login';
                    return;
                }

                // Get response text first to debug
                const responseText = await response.text();
                console.log('Raw response:', responseText.substring(0, 200));

                // Try to parse as JSON
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Failed to parse JSON response:', parseError);
                    console.error('Response was:', responseText.substring(0, 500));

                    // If we can't parse JSON but got a 200 response, it might be a successful redirect
                    if (response.status === 200) {
                        console.log('Assuming successful registration, redirecting to login');
                        window.location.href = '/login';
                        return;
                    }

                    showError('Server returned invalid response. Please try again.');
                    enableForm();
                    return;
                }

                if (data.success && data.redirect_to_stripe && data.checkout_url) {
                    console.log('✓ Checkout session created successfully');
                    console.log('✓ Redirecting to:', data.checkout_url);

                    // Validate checkout URL before redirecting
                    if (data.checkout_url && data.checkout_url.startsWith('https://checkout.stripe.com/')) {
                        console.log('✓ Valid Stripe checkout URL, redirecting...');
                        window.location.href = data.checkout_url;
                    } else {
                        console.error('❌ Invalid checkout URL received:', data.checkout_url);
                        showError('Invalid checkout URL received. Please try again.');
                        enableForm();
                    }
                    return;

                } else if (data.success && data.redirect) {
                    // Handle successful registration (beta or free users)
                    console.log('✓ Registration successful, redirecting to:', data.redirect);
                    if (data.message) {
                        // Show success message briefly before redirect
                        const successDiv = document.getElementById('paymentLoading');
                        successDiv.innerHTML = `
                            <div class="alert alert-success" role="alert">
                                <i class="fas fa-check-circle me-2"></i>
                                ${data.message}
                                <br><small class="text-muted mt-2">Redirecting to login...</small>
                            </div>
                        `;
                        successDiv.style.display = 'block';
                        
                        // Redirect after 2 seconds
                        setTimeout(() => {
                            window.location.href = data.redirect;
                        }, 2000);
                    } else {
                        window.location.href = data.redirect;
                    }
                    return;

                } else if (data.error) {
                    console.error('Registration error:', data.error);
                    showError(data.error);
                    if (data.retry) {
                        setTimeout(() => {
                            hideError();
                        }, 5000);
                    }
                    enableForm();
                    return;
                }

            } catch (error) {
                console.error('Registration error:', error);

                // Check if response is HTML (500 error page)
                if (typeof error === 'object' && error.message && error.message.includes('<!DOCTYPE html>')) {
                    showError('Server error occurred. Please try again or contact support if the problem persists.');
                } else {
                    showError('An unexpected error occurred. Please try again.');
                }
            }
        }
    });

    // Initialize
    loadPlans();

    // Password visibility toggle
    const togglePasswordButton = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('password');
    const passwordToggleIcon = document.getElementById('passwordToggleIcon');

    if (togglePasswordButton && passwordInput && passwordToggleIcon) {
        togglePasswordButton.addEventListener('click', function() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);

            // Toggle the icon
            if (type === 'password') {
                passwordToggleIcon.classList.remove('fa-eye-slash');
                passwordToggleIcon.classList.add('fa-eye');
            } else {
                passwordToggleIcon.classList.remove('fa-eye');
                passwordToggleIcon.classList.add('fa-eye-slash');
            }
        });
    }

    // Initialize form state based on invitation
    if (hasInvitation) {
        // For invitations, select company type and show team plans
        const companyCard = document.querySelector('.account-type-card[data-type="company"]');
        if (companyCard) {
            accountTypeCards.forEach(c => c.classList.remove('selected'));
            companyCard.classList.add('selected');
            organizationField.style.display = 'block';
            document.getElementById('organization_name').required = true;
            individualPlansDiv.style.display = 'none';
            teamPlansDiv.style.display = 'block';

            // Select team plan by default for invitations
            setTimeout(() => {
                const teamCard = document.querySelector('[data-level="team"]');
                if (teamCard) {
                    teamCard.click();
                }
            }, 100);
        }
    } else {
        // Initialize first options as selected (only for non-invite users)
        if (document.querySelector('.account-type-card')) {
            document.querySelector('.account-type-card').classList.add('selected');
        }
    }
});
</script>
{% endblock %}