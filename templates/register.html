
{% extends "base.html" %}

{% block title %}Sign Up - GoldenDoodleLM{% endblock %}

{% block head %}
<!-- Cache-busting meta tags -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta name="cache-bust" content="{{ range(1000000) | random }}" />
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center py-5">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow-lg border-0">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="GoldenDoodleLM Logo" style="height: 60px;" class="mb-3">
                        <h2 class="fw-bold">Create Your Account</h2>
                        
                        {% if invitation_data and invitation_data.invitation_type == 'beta' %}
                        <div class="alert alert-primary mb-4">
                            <h6 class="alert-heading mb-3"><i class="fas fa-crown me-2"></i>GoldenDoodle Founding Partner Invitation</h6>
                            <p class="mb-2"><strong>GoldenDoodle</strong> the first AI communication tool built specifically for mission-driven organizations like yours. Built by Nonprofit Communications Experts, for Nonprofits.</p>
                            <p class="mb-2">You're signing up for an <strong>Organization account</strong> with these founding partner benefits:</p>
                            <div class="mb-3">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>90-day free trial of "The Organization" plan</span>
                                </div>
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>Full access to all premium features</span>
                                </div>
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>Ability to invite team members (they get free access too!)</span>
                                </div>
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>Up to 10 brand voices</span>
                                </div>
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>No payment required during beta</span>
                                </div>
                            </div>
                            <small class="text-muted">
                                <strong>Organization:</strong> {{ invitation_data.organization_name }}<br>
                                <strong>Invited Email:</strong> {{ invitation_data.invitee_email }}
                            </small>
                        </div>
                        {% elif config.get('STRIPE_DISABLED', '').lower() == 'true' %}
                        <div class="alert alert-info">
                            <i class="fas fa-rocket me-2"></i>
                            <strong>Beta Access:</strong> All plans are currently free during our beta period!
                        </div>
                        {% endif %}
                        
                        <p class="text-muted">Join GoldenDoodleLM and transform your content creation</p>
                    </div>

                    <form method="POST" id="registerForm">
                        {% if invitation_code %}
                        <input type="hidden" name="invitation_code" value="{{ invitation_code }}">
                        {% endif %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="first_name" class="form-label fw-semibold">First Name</label>
                                    <input type="text" class="form-control" id="first_name" name="first_name"
                                           placeholder="Enter your first name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="last_name" class="form-label fw-semibold">Last Name</label>
                                    <input type="text" class="form-control" id="last_name" name="last_name"
                                           placeholder="Enter your last name" required>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label fw-semibold">Email Address</label>
                            <input type="email" class="form-control" id="email" name="email"
                                   placeholder="Enter your email"
                                   value="{{ invitation_data.invitee_email if invitation_data else '' }}"
                                   {% if invitation_data %}readonly{% endif %}
                                   required>
                            {% if invitation_data %}
                            <small class="text-muted">This email was pre-filled from your invitation.</small>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="password" class="form-label fw-semibold">Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="password" name="password"
                                       placeholder="Create a secure password" required>
                                <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                    <i class="fas fa-eye" id="passwordToggleIcon"></i>
                                </button>
                            </div>
                        </div>

                        {% if not is_organization_invite %}
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Account Type</label>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <div class="card account-type-card" data-type="independent">
                                        <div class="card-body text-center p-3">
                                            <i class="fas fa-user text-primary mb-2"></i>
                                            <h6 class="fw-bold">Individual</h6>
                                            <small class="text-muted">Personal account</small>
                                            <input type="radio" name="user_type" value="independent" class="d-none" {% if not invitation_data %}checked{% endif %}>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card account-type-card" data-type="company">
                                        <div class="card-body text-center p-3">
                                            <i class="fas fa-building text-primary mb-2"></i>
                                            <h6 class="fw-bold">Organization</h6>
                                            <small class="text-muted">Team account</small>
                                            <input type="radio" name="user_type" value="company" class="d-none" {% if invitation_data %}checked{% endif %}>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3" id="organizationField" style="{% if invitation_data %}display: block;{% else %}display: none;{% endif %}">
                            <label for="organization_name" class="form-label fw-semibold">Organization Name</label>
                            <input type="text" class="form-control" id="organization_name" name="organization_name"
                                   placeholder="Enter your organization name"
                                   value="{{ invitation_data.organization_name if invitation_data else '' }}">
                            {% if invitation_data and invitation_data.invitation_type == 'beta' %}
                            <small class="text-muted">You can change this organization name if needed.</small>
                            {% endif %}
                        </div>
                        {% endif %}

                        {% if is_organization_invite %}
                        <div class="mb-4">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                You're joining <strong>{{ organization_invite.organization_name }}</strong> as a team member.
                                Your account will be automatically configured with the appropriate access level.
                            </div>
                        </div>
                        
                        {% elif invitation_data %}
                        <div class="mb-4">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Invitation Details:</strong><br>
                                • Organization: {{ invitation_data.organization_name }}<br>
                                • Type: {{ invitation_data.invitation_type.title() }} invitation<br>
                                • Email: {{ invitation_data.invitee_email }}<br>
                                • Created: {{ invitation_data.created_at.strftime('%Y-%m-%d') if invitation_data.created_at else 'Unknown' }}
                            </div>
                        </div>
                        {% else %}
                        <div class="mb-4" id="subscriptionPlans">
                            <label class="form-label fw-semibold">Choose Your Plan</label>

                            <!-- Loading indicator for plans -->
                            <div id="plansLoadingIndicator" class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Loading plans...</span>
                                </div>
                                <p class="small text-muted mt-2">Loading pricing plans...</p>
                            </div>

                            <!-- Individual Plans -->
                            <div id="individualPlans">
                                <h6 class="text-primary mb-2">Individual Plans</h6>
                                <div class="row g-3 mb-4" id="individualPlansContainer">
                                    <!-- Plans will be loaded dynamically -->
                                </div>
                            </div>

                            <!-- Team Plans -->
                            <div id="teamPlans" style="display: none;">
                                <h6 class="text-primary mb-2">Team Plans</h6>
                                <div class="row g-3 mb-4" id="teamPlansContainer">
                                    <!-- Plans will be loaded dynamically -->
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <button type="submit" class="btn btn-primary w-100 mb-3" id="submitBtn">
                            <i class="fas fa-rocket me-2"></i>Create Account
                        </button>

                        <!-- Response Area for Status Messages -->
                        <div id="responseArea" style="display: none;">
                            <!-- Success/Error messages will be displayed here -->
                        </div>
                    </form>

                    <div class="text-center">
                        <p class="text-muted mb-0">
                            Already have an account?
                            <a href="{{ url_for('login') }}" class="text-primary text-decoration-none fw-semibold">
                                Sign in here
                            </a>
                        </p>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4">
                <small class="text-muted">
                    <i class="fas fa-shield-alt me-1"></i>
                    Your data is secure and private. We never train on your content.
                </small>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // Configuration
    const config = {
        isOrgInvite: {{ 'true' if is_organization_invite else 'false' }},
        hasInvitation: {{ 'true' if invitation_data else 'false' }},
        stripeDisabled: {{ 'true' if config.get('STRIPE_DISABLED', '').lower() == 'true' else 'false' }},
        invitationType: "{{ invitation_data.invitation_type if invitation_data else '' }}"
    };
    
    // DOM Elements
    let form, submitBtn, responseArea;
    let plansData = [];
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Registration page loaded, initializing...');
        
        // Get DOM elements
        form = document.getElementById('registerForm');
        submitBtn = document.getElementById('submitBtn');
        responseArea = document.getElementById('responseArea');
        
        if (!form || !submitBtn || !responseArea) {
            console.error('Critical DOM elements not found');
            return;
        }
        
        // AGGRESSIVE FORM PREVENTION - Multiple layers
        preventFormSubmission();
        
        // Initialize form handlers
        initializeFormHandlers();
        
        // Load plans if needed
        if (!config.hasInvitation && !config.isOrgInvite) {
            loadPlans();
        }
        
        console.log('Registration form initialized successfully');
    });
    
    function preventFormSubmission() {
        // Layer 1: onsubmit attribute override
        form.onsubmit = function(e) {
            console.log('Form onsubmit triggered - preventing default');
            e.preventDefault();
            e.stopPropagation();
            handleFormSubmission();
            return false;
        };
        
        // Layer 2: addEventListener with capture
        form.addEventListener('submit', function(e) {
            console.log('Form submit event listener triggered - preventing default');
            e.preventDefault();
            e.stopImmediatePropagation();
            handleFormSubmission();
            return false;
        }, true);
        
        // Layer 3: Submit button click handler
        submitBtn.addEventListener('click', function(e) {
            console.log('Submit button clicked - preventing form submission');
            e.preventDefault();
            e.stopPropagation();
            handleFormSubmission();
            return false;
        });
        
        // Layer 4: Form submission prevention via MutationObserver
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'action') {
                    console.log('Form action changed - resetting prevention');
                    preventFormSubmission();
                }
            });
        });
        observer.observe(form, { attributes: true, attributeFilter: ['action', 'method'] });
        
        console.log('Form submission prevention layers activated');
    }
    
    function initializeFormHandlers() {
        // Password visibility toggle
        const togglePassword = document.getElementById('togglePassword');
        const passwordInput = document.getElementById('password');
        const passwordToggleIcon = document.getElementById('passwordToggleIcon');

        if (togglePassword && passwordInput && passwordToggleIcon) {
            togglePassword.addEventListener('click', function() {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                
                if (type === 'password') {
                    passwordToggleIcon.classList.remove('fa-eye-slash');
                    passwordToggleIcon.classList.add('fa-eye');
                } else {
                    passwordToggleIcon.classList.remove('fa-eye');
                    passwordToggleIcon.classList.add('fa-eye-slash');
                }
            });
        }
        
        // Account type selection
        const accountTypeCards = document.querySelectorAll('.account-type-card');
        const organizationField = document.getElementById('organizationField');
        const individualPlansDiv = document.getElementById('individualPlans');
        const teamPlansDiv = document.getElementById('teamPlans');

        accountTypeCards.forEach(card => {
            card.addEventListener('click', function() {
                accountTypeCards.forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');

                const radio = this.querySelector('input[type="radio"]');
                radio.checked = true;

                if (radio.value === 'company') {
                    if (organizationField) {
                        organizationField.style.display = 'block';
                        document.getElementById('organization_name').required = true;
                    }
                    if (individualPlansDiv && teamPlansDiv) {
                        individualPlansDiv.style.display = 'none';
                        teamPlansDiv.style.display = 'block';
                        
                        setTimeout(() => {
                            const teamCard = document.querySelector('[data-level="team"]');
                            if (teamCard) teamCard.click();
                        }, 100);
                    }
                } else {
                    if (organizationField) {
                        organizationField.style.display = 'none';
                        document.getElementById('organization_name').required = false;
                    }
                    if (individualPlansDiv && teamPlansDiv) {
                        individualPlansDiv.style.display = 'block';
                        teamPlansDiv.style.display = 'none';
                        
                        setTimeout(() => {
                            const freeCard = document.querySelector('[data-level="free"]');
                            if (freeCard) freeCard.click();
                        }, 100);
                    }
                }
            });
        });

        // Plan selection (delegated event handling)
        document.addEventListener('click', function(e) {
            const subscriptionCard = e.target.closest('.subscription-card');
            if (subscriptionCard) {
                document.querySelectorAll('.subscription-card').forEach(c => c.classList.remove('selected'));
                subscriptionCard.classList.add('selected');

                const radio = subscriptionCard.querySelector('input[type="radio"]');
                if (radio) {
                    radio.checked = true;
                }
            }
        });
    }
    
    async function handleFormSubmission() {
        console.log('handleFormSubmission called');
        
        // Show loading state immediately
        showLoadingState();
        
        try {
            // Collect form data
            const formData = new FormData(form);
            
            console.log('Submitting registration form via AJAX...');
            
            // Make AJAX request
            const response = await fetch('/register', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            });
            
            console.log('Response status:', response.status);
            console.log('Response content-type:', response.headers.get('content-type'));
            
            // Parse response
            let data;
            try {
                const responseText = await response.text();
                console.log('Raw response:', responseText.substring(0, 200) + '...');
                data = JSON.parse(responseText);
                console.log('Parsed JSON response:', data);
            } catch (parseError) {
                console.error('Failed to parse response as JSON:', parseError);
                showErrorState('Invalid response from server. Please try again.');
                return;
            }
            
            // Handle response
            if (data.success) {
                console.log('✓ Registration successful');
                
                // Check if this is a Stripe checkout redirect
                if (data.redirect_to_stripe && data.checkout_url) {
                    console.log('✓ Redirecting to Stripe checkout:', data.checkout_url);
                    if (data.checkout_url && data.checkout_url.startsWith('https://checkout.stripe.com/')) {
                        window.location.href = data.checkout_url;
                    } else {
                        showErrorState('Invalid checkout URL received. Please try again.');
                    }
                    return;
                }
                
                // Handle regular success
                const redirectUrl = data.redirect || '/login';
                const message = data.message || 'Account created successfully!';
                
                showSuccessState(message, redirectUrl);
                
            } else if (data.error) {
                console.error('Registration error:', data.error);
                showErrorState(data.error);
            } else {
                console.error('Unexpected response format');
                showErrorState('Unexpected response from server. Please try again.');
            }
            
        } catch (error) {
            console.error('Registration request failed:', error);
            showErrorState('Network error occurred. Please check your connection and try again.');
        }
    }
    
    function showLoadingState() {
        console.log('Showing loading state');
        
        submitBtn.style.display = 'none';
        responseArea.style.display = 'block';
        
        const isBeta = config.invitationType === 'beta';
        const isOrg = config.isOrgInvite;
        
        let message = 'Creating your account...';
        if (isBeta || isOrg) {
            message = 'Setting up your organization account...';
        }
        
        responseArea.innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="small text-muted mt-2">${message}</p>
            </div>
        `;
    }
    
    function showSuccessState(message, redirectUrl) {
        console.log('Showing success state, will redirect to:', redirectUrl);
        
        responseArea.innerHTML = `
            <div class="alert alert-success text-center" role="alert">
                <div class="mb-3">
                    <i class="fas fa-check-circle" style="font-size: 3rem; color: #28a745;"></i>
                </div>
                <h5 class="alert-heading">Account Created Successfully!</h5>
                <p class="mb-3">${message}</p>
                <div class="spinner-border spinner-border-sm text-success" role="status">
                    <span class="visually-hidden">Redirecting...</span>
                </div>
                <p class="small text-muted mt-2">Redirecting to login page in 3 seconds...</p>
            </div>
        `;
        
        // Redirect after 3 seconds
        setTimeout(() => {
            console.log('Redirecting to:', redirectUrl);
            window.location.href = redirectUrl;
        }, 3000);
    }
    
    function showErrorState(errorMessage) {
        console.log('Showing error state:', errorMessage);
        
        responseArea.innerHTML = `
            <div class="alert alert-danger text-center" role="alert">
                <div class="mb-3">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #dc3545;"></i>
                </div>
                <h5 class="alert-heading">Registration Error</h5>
                <p class="mb-0">${errorMessage}</p>
            </div>
        `;
        
        // Show submit button again after 3 seconds
        setTimeout(() => {
            submitBtn.style.display = 'block';
            responseArea.style.display = 'none';
        }, 5000);
    }
    
    // Load pricing plans (simplified version)
    async function loadPlans() {
        try {
            console.log('Loading pricing plans...');
            const response = await fetch('/api/get-plans');
            if (!response.ok) {
                throw new Error('Failed to load plans');
            }

            plansData = await response.json();
            renderPlans();
            document.getElementById('plansLoadingIndicator').style.display = 'none';
            console.log('Plans loaded successfully');
        } catch (error) {
            console.error('Error loading plans:', error);
            const indicator = document.getElementById('plansLoadingIndicator');
            if (indicator) {
                indicator.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Failed to load pricing plans. Please refresh the page.
                    </div>
                `;
            }
        }
    }
    
    function renderPlans() {
        const individualContainer = document.getElementById('individualPlansContainer');
        const teamContainer = document.getElementById('teamPlansContainer');
        
        if (!individualContainer || !teamContainer || !plansData.length) {
            return;
        }

        // Clear containers
        individualContainer.innerHTML = '';
        teamContainer.innerHTML = '';

        // Individual plans
        const individualPlans = plansData.filter(plan => ['free', 'solo', 'professional'].includes(plan.plan_id));
        individualPlans.forEach(plan => {
            individualContainer.appendChild(createPlanCard(plan));
        });

        // Team plans
        const teamPlans = plansData.filter(plan => ['team'].includes(plan.plan_id));
        teamPlans.forEach(plan => {
            teamContainer.appendChild(createPlanCard(plan));
        });
    }
    
    function createPlanCard(plan) {
        const col = document.createElement('div');
        col.className = 'col-md-6';

        let priceDisplay, badgeClass, trialText;
        if (plan.plan_id === 'free') {
            priceDisplay = 'Free';
            badgeClass = 'bg-success';
            trialText = 'Always Free';
        } else if (plan.plan_id === 'team') {
            priceDisplay = `$${plan.price_monthly}/user/mo`;
            badgeClass = 'bg-info';
            trialText = '7-Day Free Trial';
        } else {
            priceDisplay = `$${plan.price_monthly}/mo`;
            badgeClass = plan.plan_id === 'solo' ? 'bg-success' : 'bg-warning';
            trialText = '7-Day Free Trial';
        }

        const features = getPlanFeatures(plan);

        col.innerHTML = `
            <div class="card subscription-card h-100" data-level="${plan.plan_id}">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="fw-bold text-primary">${plan.name}</h6>
                        <span class="badge ${badgeClass}">${priceDisplay}</span>
                    </div>
                    ${plan.plan_id !== 'free' ? `
                    <div class="text-center mb-2">
                        <small class="badge bg-light text-dark border">
                            <i class="fas fa-gift me-1"></i>${trialText}
                        </small>
                    </div>
                    ` : ''}
                    <p class="small text-muted mb-2">${plan.target_user}</p>
                    <ul class="list-unstyled small mb-0">
                        ${features.map(feature => `
                            <li>
                                <i class="fas fa-${feature.available ? 'check text-success' : 'times text-muted'} me-1"></i>
                                ${feature.text}
                            </li>
                        `).join('')}
                    </ul>
                    <input type="radio" name="subscription_level" value="${plan.plan_id}" class="d-none">
                </div>
            </div>
        `;

        return col;
    }
    
    function getPlanFeatures(plan) {
        const features = [];
        
        if (plan.plan_id === 'team') {
            features.push({ text: 'Minimum 3 User Seats', available: true });
        } else {
            features.push({ text: '1 User Seat', available: true });
        }
        
        if (plan.brand_voices > 0) {
            const voiceText = plan.brand_voices === 1 ? '1 Brand Voice' : `Up to ${plan.brand_voices} Brand Voices`;
            features.push({ text: voiceText, available: true });
        }
        
        if (plan.templates === 'full') {
            features.push({ text: 'Full Template Library', available: true });
        } else if (plan.templates === 'basic') {
            features.push({ text: 'Basic Templates', available: true });
        }
        
        if (plan.analysis_brainstorm) {
            features.push({ text: 'Analysis & Brainstorm Tools', available: true });
        }
        
        if (plan.admin_controls) {
            features.push({ text: 'Admin Controls & User Management', available: true });
        }
        
        const supportLevels = {
            'none': 'Community Support',
            'email': 'Email Support', 
            'priority': 'Priority Support'
        };
        
        features.push({
            text: supportLevels[plan.support_level] || 'Support',
            available: plan.support_level !== 'none'
        });
        
        return features;
    }
    
})();
</script>
{% endblock %}
